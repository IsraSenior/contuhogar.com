# Simulador Session Tracking

## Overview

This system tracks user progress through the credit simulator funnel to provide analytics on user behavior, drop-off points, and completion rates.

## Architecture

### Database Collection: `simulador_sesiones`

This Directus collection stores session tracking data for each user who starts the simulator.

#### Required Fields

| Field | Type | Description |
|-------|------|-------------|
| `id` | UUID | Primary key (auto-generated) |
| `session_id` | UUID | Client-generated session identifier (unique) |
| `status` | String | Current status (see Status Values below) |
| `paso_actual` | Integer | Current step number (1-5) |
| `paso_maximo_alcanzado` | Integer | Highest step reached (1-5) |
| `tiempo_inicio` | DateTime | Timestamp when session started |
| `tiempo_paso_1` | DateTime | Timestamp when step 1 was reached |
| `tiempo_paso_2` | DateTime | Timestamp when step 2 was reached |
| `tiempo_paso_3` | DateTime | Timestamp when step 3 was reached |
| `tiempo_paso_4` | DateTime | Timestamp when step 4 was reached |
| `tiempo_paso_5` | DateTime | Timestamp when step 5 was reached |
| `tiempo_completado` | DateTime | Timestamp when simulation was completed |
| `tiempo_total_segundos` | Integer | Total time from start to completion (seconds) |
| `source_page` | String | URL or path where user started |
| `ip_address` | String | Client IP address |
| `user_agent` | String | Browser user agent |
| `device_type` | String | Device type: mobile, tablet, or desktop |
| `datos_paso_1` | JSON | Partial data from step 1 |
| `datos_paso_2` | JSON | Partial data from step 2 |
| `datos_paso_3` | JSON | Partial data from step 3 |
| `datos_paso_4` | JSON | Partial data from step 4 |
| `datos_paso_5` | JSON | Partial data from step 5 |
| `simulacion_id` | UUID | Foreign key to simulaciones_credito (when completed) |
| `date_created` | DateTime | Auto-generated by Directus |
| `date_updated` | DateTime | Auto-updated by Directus |

#### Status Values

- `paso_1_datos_personales` - User on step 1 (Personal Info)
- `paso_2_datos_bien` - User on step 2 (Property Info)
- `paso_3_datos_ingresos` - User on step 3 (Income Info)
- `paso_4_elegibilidad` - User on step 4 (Eligibility)
- `paso_5_resultados` - User on step 5 (Results)
- `completado` - User completed and saved simulation
- `abandonado` - User abandoned (can be set by cleanup job)

#### Indexes

Recommended indexes for performance:
- `session_id` (unique)
- `status`
- `date_created`
- `paso_maximo_alcanzado`
- `simulacion_id`

## API Endpoints

### 1. Start Session

**POST** `/api/simulador/session/start`

Creates a new session record when user starts the simulator.

**Request Body:**
```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "source_page": "/simulador/credito"
}
```

**Response:**
```json
{
  "ok": true,
  "session_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Rate Limit:** 20 requests per 5 minutes

**Notes:**
- If session_id already exists, returns success (idempotent)
- Automatically captures IP, user agent, and device type
- Sets initial status to `paso_1_datos_personales`
- Sets both `tiempo_inicio` and `tiempo_paso_1` to current timestamp

### 2. Update Session

**POST** `/api/simulador/session/update`

Updates session when user advances to a new step.

**Request Body:**
```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "paso": 2,
  "datos_parciales": {
    "nombres": "Juan",
    "apellidos": "PÃ©rez",
    "correo": "juan@example.com"
  }
}
```

**Response:**
```json
{
  "ok": true
}
```

**Rate Limit:** 50 requests per 5 minutes

**Notes:**
- Updates `paso_actual` to new step
- Updates `paso_maximo_alcanzado` if new step is higher
- Sets corresponding `tiempo_paso_X` timestamp
- Updates status to corresponding step status
- Stores `datos_parciales` in `datos_paso_X` JSON field
- Returns 404 if session not found

### 3. Complete Session

**POST** `/api/simulador/session/complete`

Marks session as completed and links to saved simulation.

**Request Body:**
```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "simulacion_id": "660e8400-e29b-41d4-a716-446655440000"
}
```

**Response:**
```json
{
  "ok": true
}
```

**Rate Limit:** 10 requests per 5 minutes

**Notes:**
- Sets status to `completado`
- Sets `tiempo_completado` to current timestamp
- Links `simulacion_id` to the saved simulation
- Calculates and stores `tiempo_total_segundos`
- Returns 404 if session not found

## Client-Side Integration

### Step 1: Generate Session ID

When user first loads the simulator page, generate a UUID:

```typescript
import { v4 as uuidv4 } from 'uuid';

const sessionId = uuidv4();
```

### Step 2: Start Session Tracking

Call the start endpoint when component mounts:

```typescript
async function startSession() {
  try {
    await $fetch('/api/simulador/session/start', {
      method: 'POST',
      body: {
        session_id: sessionId,
        source_page: window.location.pathname
      }
    });
  } catch (error) {
    // Log error but don't block user experience
    console.error('Session tracking failed:', error);
  }
}
```

### Step 3: Update on Step Changes

Call update endpoint when user advances:

```typescript
async function updateSession(paso: number, data: any) {
  try {
    await $fetch('/api/simulador/session/update', {
      method: 'POST',
      body: {
        session_id: sessionId,
        paso,
        datos_parciales: data
      }
    });
  } catch (error) {
    // Log error but don't block user experience
    console.error('Session update failed:', error);
  }
}
```

### Step 4: Complete on Save

Call complete endpoint after successful simulation save:

```typescript
async function completeSession(simulacionId: string) {
  try {
    await $fetch('/api/simulador/session/complete', {
      method: 'POST',
      body: {
        session_id: sessionId,
        simulacion_id: simulacionId
      }
    });
  } catch (error) {
    // Log error but don't block user experience
    console.error('Session completion failed:', error);
  }
}
```

## Error Handling Philosophy

**All session tracking calls should be non-blocking:**
- Use try-catch blocks to prevent errors from breaking user flow
- Log errors for debugging but never show them to users
- If tracking fails, simulator should continue working normally
- Tracking is for analytics only - never a requirement for functionality

## Analytics Queries

### Funnel Drop-off Analysis

```sql
SELECT
  paso_maximo_alcanzado,
  COUNT(*) as sessions,
  COUNT(*) * 100.0 / SUM(COUNT(*)) OVER () as percentage
FROM simulador_sesiones
WHERE date_created >= NOW() - INTERVAL '30 days'
GROUP BY paso_maximo_alcanzado
ORDER BY paso_maximo_alcanzado;
```

### Completion Rate

```sql
SELECT
  COUNT(CASE WHEN status = 'completado' THEN 1 END) as completed,
  COUNT(*) as total,
  COUNT(CASE WHEN status = 'completado' THEN 1 END) * 100.0 / COUNT(*) as completion_rate
FROM simulador_sesiones
WHERE date_created >= NOW() - INTERVAL '30 days';
```

### Average Time by Step

```sql
SELECT
  AVG(EXTRACT(EPOCH FROM (tiempo_paso_2 - tiempo_paso_1))) as avg_step_1_seconds,
  AVG(EXTRACT(EPOCH FROM (tiempo_paso_3 - tiempo_paso_2))) as avg_step_2_seconds,
  AVG(EXTRACT(EPOCH FROM (tiempo_paso_4 - tiempo_paso_3))) as avg_step_3_seconds,
  AVG(EXTRACT(EPOCH FROM (tiempo_paso_5 - tiempo_paso_4))) as avg_step_4_seconds
FROM simulador_sesiones
WHERE status = 'completado'
  AND date_created >= NOW() - INTERVAL '30 days';
```

### Device Type Distribution

```sql
SELECT
  device_type,
  COUNT(*) as sessions,
  COUNT(CASE WHEN status = 'completado' THEN 1 END) as completed,
  COUNT(CASE WHEN status = 'completado' THEN 1 END) * 100.0 / COUNT(*) as completion_rate
FROM simulador_sesiones
WHERE date_created >= NOW() - INTERVAL '30 days'
GROUP BY device_type;
```

## Maintenance

### Cleanup Old Sessions

Consider creating a scheduled job to mark abandoned sessions:

```sql
UPDATE simulador_sesiones
SET status = 'abandonado'
WHERE status != 'completado'
  AND status != 'abandonado'
  AND date_updated < NOW() - INTERVAL '7 days';
```

### Archive Old Data

After 1 year, consider archiving sessions to a separate table:

```sql
INSERT INTO simulador_sesiones_archive
SELECT * FROM simulador_sesiones
WHERE date_created < NOW() - INTERVAL '1 year';

DELETE FROM simulador_sesiones
WHERE date_created < NOW() - INTERVAL '1 year';
```

## Security Considerations

1. **Rate Limiting:** All endpoints have rate limiting to prevent abuse
2. **Payload Validation:** All inputs validated with Zod schemas
3. **IP Tracking:** IP addresses logged for security analysis
4. **No PII in datos_parciales:** Avoid storing sensitive data in step data
5. **Server-side only:** All tracking done server-side via Directus admin token

## Related Files

- `/server/api/simulador/session/start.post.ts` - Start endpoint
- `/server/api/simulador/session/update.post.ts` - Update endpoint
- `/server/api/simulador/session/complete.post.ts` - Complete endpoint
- `/server/utils/deviceDetection.ts` - Device type detection helper
- `/server/utils/rateLimit.ts` - Rate limiting utility
